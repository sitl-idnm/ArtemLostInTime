<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Управление Записями</title>
	<style>
		body {
			font-family: sans-serif;
			margin: 20px;
			background-color: #f4f4f4;
		}

		h1,
		h2 {
			color: #333;
		}

		#add-entry-form,
		#entries-list {
			background-color: #fff;
			padding: 20px;
			margin-bottom: 20px;
			border-radius: 5px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		label {
			display: block;
			margin-bottom: 5px;
			color: #555;
		}

		input[type="number"],
		input[type="datetime-local"] {
			width: 95%;
			padding: 10px;
			margin-bottom: 15px;
			border: 1px solid #ddd;
			border-radius: 3px;
		}

		button {
			background-color: #007bff;
			color: white;
			padding: 10px 15px;
			border: none;
			border-radius: 3px;
			cursor: pointer;
			margin-right: 5px;
		}

		button:hover {
			background-color: #0056b3;
		}

		button.return-button {
			background-color: #28a745;
		}

		button.return-button:hover {
			background-color: #218838;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 20px;
		}

		th,
		td {
			border: 1px solid #ddd;
			padding: 12px;
			text-align: left;
		}

		th {
			background-color: #e9ecef;
			color: #495057;
		}

		tr:nth-child(even) {
			background-color: #f8f9fa;
		}

		.error-message {
			color: red;
			margin-top: 10px;
		}

		.success-message {
			color: green;
			margin-top: 10px;
		}
	</style>
</head>

<body>

	<h1>Управление Записями</h1>

	<div id="add-entry-form">
		<h2>Добавить новую запись (Уход)</h2>
		<form id="entry-form">
			<!-- Скрытое поле для времени ухода, будет заполняться JS -->
			<input type="hidden" id="departureTime" name="departureTime">

			<label for="estimatedDuration">Ушел на (минут):</label>
			<input type="number" id="estimatedDuration" name="estimatedDuration" required min="1">

			<button type="submit">Отметить Уход</button>
		</form>
		<div id="form-message" class="error-message"></div>
	</div>

	<div id="entries-list">
		<h2>Список Записей</h2>
		<button id="refresh-button">Обновить список</button>
		<table id="entries-table">
			<thead>
				<tr>
					<th>Время ухода</th>
					<th>Ушел на (мин)</th>
					<th>Ожидаемое время возвращения</th>
					<th>Время прихода</th>
					<th>Опоздание (мин)</th>
					<th>Действие</th>
				</tr>
			</thead>
			<tbody id="entries-tbody">
				<!-- Данные будут загружены сюда -->
			</tbody>
		</table>
		<div id="list-message" class="error-message"></div>
	</div>

	<script>
		const API_URL = '/entries'; // Адрес нашего API - ИЗМЕНЕН НА ОТНОСИТЕЛЬНЫЙ
		const entriesTbody = document.getElementById('entries-tbody');
		const entryForm = document.getElementById('entry-form');
		const estimatedDurationInput = document.getElementById('estimatedDuration');
		const formMessage = document.getElementById('form-message');
		const listMessage = document.getElementById('list-message');
		const refreshButton = document.getElementById('refresh-button');

		// Функция для форматирования даты и времени
		function formatDateTime(isoString) {
			if (!isoString) return '-';
			try {
				const date = new Date(isoString);
				// Проверка на валидность даты
				if (isNaN(date.getTime())) return 'Invalid Date';
				return date.toLocaleString('ru-RU', {
					year: 'numeric', month: 'numeric', day: 'numeric',
					hour: '2-digit', minute: '2-digit', second: '2-digit'
				});
			} catch (e) {
				console.error("Error formatting date:", e);
				return 'Invalid Date';
			}
		}

		// Функция для расчета ожидаемого времени возвращения
		function calculateExpectedReturn(departureTimeISO, durationMinutes) {
			if (!departureTimeISO || !durationMinutes) return null;
			try {
				const departureDate = new Date(departureTimeISO);
				if (isNaN(departureDate.getTime())) return null;
				const expectedReturnDate = new Date(departureDate.getTime() + durationMinutes * 60000);
				return expectedReturnDate.toISOString();
			} catch (e) {
				console.error("Error calculating expected return:", e);
				return null;
			}
		}

		// Функция для загрузки и отображения записей
		async function fetchEntries() {
			listMessage.textContent = ''; // Очистить сообщение об ошибке
			entriesTbody.innerHTML = '<tr><td colspan="6">Загрузка...</td></tr>'; // Показать индикатор загрузки
			try {
				const response = await fetch(API_URL);
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				const entries = await response.json();

				entriesTbody.innerHTML = ''; // Очистить таблицу перед заполнением
				if (entries.length === 0) {
					entriesTbody.innerHTML = '<tr><td colspan="6">Записей пока нет.</td></tr>';
				} else {
					entries.forEach(entry => {
						const expectedReturnISO = calculateExpectedReturn(entry.departureTime, entry.estimatedDuration);
						const row = entriesTbody.insertRow();
						row.innerHTML = `
                            <td>${formatDateTime(entry.departureTime)}</td>
                            <td>${entry.estimatedDuration}</td>
                            <td>${formatDateTime(expectedReturnISO)}</td>
                            <td>${formatDateTime(entry.returnTime)}</td>
                            <td>${entry.lateBy !== null ? entry.lateBy : '-'}</td>
                            <td>
                                ${!entry.returnTime ?
								`<button class="return-button" data-id="${entry.id}">Пришел</button>` :
								'Вернулся'}
                            </td>
                        `;
					});
				}
			} catch (error) {
				console.error('Ошибка при загрузке записей:', error);
				entriesTbody.innerHTML = '';
				let errorDetails = error.message;
				if (error instanceof Response) {
					try {
						const errorData = await error.json();
						errorDetails = `${error.statusText}: ${errorData.message} - ${errorData.details || 'No details'}`;
					} catch (e) {
						errorDetails = `${error.statusText || 'Unknown HTTP error'}`;
					}
				}
				listMessage.textContent = `Не удалось загрузить записи: ${errorDetails}. Убедитесь, что API сервер запущен и доступен.`;
			}
		}

		// Обработчик отправки формы добавления записи
		entryForm.addEventListener('submit', async (event) => {
			event.preventDefault(); // Предотвратить стандартную отправку формы
			formMessage.textContent = ''; // Очистить сообщение

			const departureTime = new Date().toISOString(); // Текущее время
			const estimatedDuration = parseInt(estimatedDurationInput.value, 10);

			if (isNaN(estimatedDuration) || estimatedDuration <= 0) {
				formMessage.textContent = 'Пожалуйста, введите корректную длительность (положительное число минут).';
				return;
			}

			try {
				const response = await fetch(API_URL, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ departureTime, estimatedDuration })
				});

				if (!response.ok) {
					const errorText = await response.text();
					throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
				}

				estimatedDurationInput.value = ''; // Очистить поле ввода
				formMessage.textContent = 'Запись успешно добавлена!';
				formMessage.className = 'success-message';
				fetchEntries(); // Обновить список после добавления

				// Очистить сообщение об успехе через пару секунд
				setTimeout(() => { formMessage.textContent = ''; formMessage.className = 'error-message'; }, 3000);

			} catch (error) {
				console.error('Ошибка при добавлении записи:', error);
				let errorDetails = error.message;
				if (error instanceof Response) {
					try {
						const errorData = await error.json();
						errorDetails = `${error.statusText}: ${errorData.message} - ${errorData.details || 'No details'}`;
					} catch (e) {
						errorDetails = `${error.statusText || 'Unknown HTTP error'}`;
					}
				}
				formMessage.textContent = `Ошибка: ${errorDetails}`;
				formMessage.className = 'error-message';
			}
		});

		// Обработчик нажатия кнопки "Пришел" (используем делегирование событий)
		entriesTbody.addEventListener('click', async (event) => {
			if (event.target.classList.contains('return-button')) {
				const button = event.target;
				const entryId = button.dataset.id;
				const returnTime = new Date().toISOString(); // Текущее время прихода

				button.disabled = true; // Отключить кнопку на время запроса
				button.textContent = 'Обновление...';
				listMessage.textContent = ''; // Очистить предыдущее сообщение об ошибке

				try {
					const response = await fetch(`${API_URL}/${entryId}`, {
						method: 'PUT',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ returnTime })
					});

					if (!response.ok) {
						const errorText = await response.text();
						throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
					}

					fetchEntries(); // Обновить список после успешного обновления

				} catch (error) {
					console.error('Ошибка при обновлении записи:', error);
					let errorDetails = error.message;
					if (error instanceof Response) {
						try {
							const errorData = await error.json();
							errorDetails = `${error.statusText}: ${errorData.message} - ${errorData.details || 'No details'}`;
						} catch (e) {
							errorDetails = `${error.statusText || 'Unknown HTTP error'}`;
						}
					}
					listMessage.textContent = `Ошибка обновления записи ID ${entryId}: ${errorDetails}`;
					button.disabled = false;
					button.textContent = 'Пришел';
				}
			}
		});

		// Обработчик кнопки "Обновить список"
		refreshButton.addEventListener('click', fetchEntries);

		// Первоначальная загрузка записей при открытии страницы
		fetchEntries();
	</script>

</body>

</html>
